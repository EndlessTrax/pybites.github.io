
<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="google-site-verification" content="lyiNqmFUtae2FGps4eCalBloZekygEIfjiV8tSPrjMY" />
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="https://pybit.es/theme/stylesheet/style.min.css">
  <link rel="stylesheet" type="text/css" href="https://pybit.es/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="https://pybit.es/theme/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="//cdn-images.mailchimp.com/embedcode/classic-10_7.css">
  <link rel="stylesheet" type="text/css" href="https://pybit.es/theme/stylesheet/ribbons.css">
  <link rel="stylesheet" type="text/css" href="https://pybit.es/theme/stylesheet/custom.css">

    <link href="https://pybit.es/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="PyBites Atom">

    <link href="https://pybit.es/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="PyBites RSS">

    <link rel="shortcut icon" href="https://pybit.es/favicon.ico" type="image/x-icon">
    <link rel="icon" href="https://pybit.es/favicon.ico" type="image/x-icon">

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />


<meta name="author" content="Bob" />
<meta name="description" content="In this article I will show you how to build a simple API for our growing collection of Python tips. First we make a simple Django app, defining the model. Next we use Django REST Framework to make an API supporting common CRUD operations. Then we will test it out using curl, Postman and Django REST's browser front-end. Lastly we deploy the API to Digital Ocean so we can start using it via our Slack with a Slash Command, which I will cover in the next article. Sounds exciting? You bet it is! Let's jump straight in!" />
<meta name="keywords" content="Django, APIs, Django REST Framework, tips, Digital Ocean, Django Commands, Postman, Nginx, postgres, Gunicorn, BeautifulSoup, requests, curl, SSH, Linux, deployment">
<meta property="og:site_name" content="PyBites"/>
<meta property="og:title" content="Building a Python Tips API with Django REST Framework and Deploying it to Digital Ocean"/>
<meta property="og:description" content="In this article I will show you how to build a simple API for our growing collection of Python tips. First we make a simple Django app, defining the model. Next we use Django REST Framework to make an API supporting common CRUD operations. Then we will test it out using curl, Postman and Django REST's browser front-end. Lastly we deploy the API to Digital Ocean so we can start using it via our Slack with a Slash Command, which I will cover in the next article. Sounds exciting? You bet it is! Let's jump straight in!"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://pybit.es/django-rest-tips-api-digital-ocean.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2019-03-05 12:30:00+01:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://pybit.es/author/bob.html">
<meta property="article:section" content="Django"/>
<meta property="article:tag" content="Django"/>
<meta property="article:tag" content="APIs"/>
<meta property="article:tag" content="Django REST Framework"/>
<meta property="article:tag" content="tips"/>
<meta property="article:tag" content="Digital Ocean"/>
<meta property="article:tag" content="Django Commands"/>
<meta property="article:tag" content="Postman"/>
<meta property="article:tag" content="Nginx"/>
<meta property="article:tag" content="postgres"/>
<meta property="article:tag" content="Gunicorn"/>
<meta property="article:tag" content="BeautifulSoup"/>
<meta property="article:tag" content="requests"/>
<meta property="article:tag" content="curl"/>
<meta property="article:tag" content="SSH"/>
<meta property="article:tag" content="Linux"/>
<meta property="article:tag" content="deployment"/>
<meta property="og:image" content="https://pybit.es/images/featured/pb-article.png">

<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@pybites" />
<meta name="twitter:title" content="Building a Python Tips API with Django REST Framework and Deploying it to Digital Ocean" />
<meta name="twitter:description" content="In this article I will show you how to build a simple API for our growing collection of Python tips. First we make a simple Django app, defining the model. Next we use Django REST Framework to make an API supporting common CRUD operations. Then we will test it out using curl, Postman and Django REST's browser front-end. Lastly we deploy the API to Digital Ocean so we can start using it via our Slack with a Slash Command, which I will cover in the next article. Sounds exciting? You bet it is! Let's jump straight in!" />
<meta name="twitter:image" content="https://pybit.es/images/featured/pb-article.png">

  <title>PyBites &ndash; Building a Python Tips API with Django REST Framework and Deploying it to Digital Ocean</title>


</head>
<body>
<div id="codeChallengeWrapper">

  <div id="codeWithUs">

    <div class="quote-box">
      <div class="quote">

        <img src="https://codechalleng.es/static/img/honors/unlock.png" class="ninja" alt="earn the White PyBites Ninja">
        <img src="https://codechalleng.es/static/img/honors/unlock_yellow.png" class="ninja" alt="earn the Yellow PyBites Ninja">
        <img src="https://codechalleng.es/static/img/honors/unlock_orange.png" class="ninja" alt="earn the Orange PyBites Ninja">
        <img src="https://codechalleng.es/static/img/right-arrow.png" class="ninja" alt="right arrow">
        <img src="https://codechalleng.es/static/img/honors/unlock_red.png" class="ninja" alt="earn more PyBites Ninja belts and certificates">

        <hr>

        <blockquote>
          The best way to learn to <strong>code in Python</strong> is to <strong><a href="https://pybit.es/learn-by-doing.html" target="_blank">actually use the language</a></strong>.
          <br><br>
          Our platform offers <strong>effective Test Driven Learning</strong> which will be key to your progress.
          <br><br><br>
          Join thousands of Pythonistas and start coding!

          <br><br><br>
          <a href="https://codechalleng.es/via/pybites" target="_blank"><img src="https://codechalleng.es/static/img/ghlogin.png" alt="Join us on our PyBites Platform"></a>
        </blockquote>
  
      </div>
    </div>

  </div>

  <button class="center mui-btn mui-btn--flat mui-btn--primary" onclick="document.getElementById('codeWithUs').classList.toggle('open');">
    Hone Your Python Skills, Become a PyBites Ninja &raquo;
  </button>

</div><!-- end codeChallengeWrapper -->

  <!-- change ribbon color based on topic -->
  <div class="ribbon right
      blue
  ">
    <a href="https://codechalleng.es/via/pybites" target="_blank">Click here to code!</a>
  </div>

  <!-- change aside color based on topic -->
    <aside class='blue'>
  
    <div>
      <a href="https://pybit.es">
          <img src="https://pybit.es/theme/img/article.png" alt="PyBites" title="PyBites">
      </a>
      <h1><a href="https://pybit.es">PyBites</a></h1>

<h2 id="sitesubtitle">A Community that Masters Python through Code Challenges</h2>
      <nav>
        <ul class="list">
          <li><a href="/pages/about.html">About</a></li>
          <li><a href="/pages/articles.html">Articles</a></li>
          <li><a href="/pages/challenges.html">Code Challenges</a></li>
          <li><a href="/pages/courses.html">#100DaysOfCode</a></li>
          <li><a href="/pages/news.html">Python News</a></li>
          <li><a href="/pages/search.html">Search</a></li>
        </ul>
      </nav>

      <div id='mc-dark'>
<!-- Begin MailChimp Signup Form -->
<hr class="softDivider">
<div id="mc_embed_signup">
<form action="//pybit.us14.list-manage.com/subscribe/post?u=822043293f280259d4b8d2a3e&amp;id=ac7e2eb9ef" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
    
<div class="mc-field-group">
  <p><a href='http://us14.campaign-archive1.com/home/?u=822043293f280259d4b8d2a3e&id=ac7e2eb9ef'>Join our community</a> and grab our <i>Become a Better Python Developer</i> cheat sheet. Learn Python. Receive bonus material. Challenge yourself! (<a href="https://pybit.es/pages/privacy-policy">Privacy Policy</a>)</p>
    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
</div>
    <div id="mce-responses" class="clear">
        <div class="response" id="mce-error-response" style="display:none"></div>
        <div class="response" id="mce-success-response" style="display:none"></div>
    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_822043293f280259d4b8d2a3e_ac7e2eb9ef" tabindex="-1" value=""></div>
    <div class="clear"><input type="submit" value="Join Us" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
    </div>
</form>
</div>
<!--End mc_embed_signup-->                  </div>

      <hr class="softDivider">

      <div id="ninjaWidget">
        <a href="https://codechalleng.es/via/pybites" target="_blank"><img src="https://codechalleng.es/static/img/honors/ninja_widget.png" alt="start earning PyBites Ninja Belts"></a>
      </div>
        
      <ul class="social">
        <li><a href="https://twitter.com/pybites" target="_blank"><img src='https://pybit.es/theme/img/socialmedia/twitter.png' alt='Follow us on Twitter'></a></li>
        <li><a href="https://github.com/pybites/" target="_blank"><img src='https://pybit.es/theme/img/socialmedia/github.png' alt='Follow us on Github'></a></li>
        <li><a href="https://instagram.com/pybites" target="_blank"><img src='https://pybit.es/theme/img/socialmedia/instagram.png' alt='Follow us on Instagram'></a></li>
        <li><a href="https://www.youtube.com/channel/UCBn-uKDGsRBfcB0lQeOB_gA" target="_blank"><img src='https://pybit.es/theme/img/socialmedia/youtube.png' alt='Follow us on Youtube'></a></li>
        <li><a href="https://www.facebook.com/groups/pybites/" target="_blank"><img src='https://pybit.es/theme/img/socialmedia/facebook.png' alt='Follow us on Facebook'></a></li>
      </ul>

      <br>
      <script src="https://apis.google.com/js/platform.js"></script>

	
    </div>


  </aside>
  <main>


<article class="single">
  <header>
    <h1 id="django-rest-tips-api-digital-ocean">Building a Python Tips API with Django REST Framework and Deploying it to Digital Ocean</h1>
    <p>
          Posted by <a href="https://pybit.es/author/bob.html">Bob</a> on Tue 05 March 2019 in <a href="https://pybit.es/category/django.html">Django</a>


        &#8226; 15 min read
    </p>
  </header>


  <div>
    <p>In this article I will show you how to build a simple API for our growing collection of Python tips:</p>
<ul>
<li>First we make a simple Django app, defining the model.</li>
<li>Next we use Django REST Framework to make an API supporting common CRUD operations.</li>
<li>Then we will test it out using curl, Postman and Django REST's browser front-end.</li>
<li>Lastly we deploy the API to Digital Ocean so we can start using it via our Slack with a Slash Command, which I will cover in the next article.</li>
</ul>
<p>Sounds exciting? You bet it is! Let's jump straight in!</p>
<h2>Setup</h2>
<p><em>If you want to follow along, the final code is <a href="https://github.com/pybites/python_tips">here</a></em>.</p>
<p>First we make <a href="https://pybit.es/the-beauty-of-virtualenv.html">a virtual environment</a> and <code>pip install</code> <a href="https://github.com/pybites/python_tips/requirements.txt">the requirements</a> which include:</p>
<ul>
<li><code>django</code> to build the app,</li>
<li><code>django-rest</code> to build the API,</li>
<li><code>bs4</code> (<code>BeautifulSoup</code>) and <code>requests</code> to parse the existing tips from our platform,</li>
<li><code>psycopg2</code> and <code>gunicorn</code> for deployment on <a href="https://www.digitalocean.com/">Digital Ocean</a>.</li>
</ul>
<p>So here we go:</p>
<div class="highlight"><pre><span></span>[bobbelderbos@imac code]$ mkdir tips_api &amp;&amp; cd $_
[bobbelderbos@imac tips_api]$ alias pvenv
alias pvenv=&#39;/Library/Frameworks/Python.framework/Versions/3.7/bin/python3.7 -m venv venv &amp;&amp; source venv/bin/activate&#39;
[bobbelderbos@imac tips_api]$ pvenv
(venv) [bobbelderbos@imac tips_api]$ python -V
Python 3.7.0
(venv) [bobbelderbos@imac tips_api]$ pip install -r requirements.txt
...
</pre></div>


<p>Let's set the following 2 environment variables as referenced in Django's <code>settings.py</code> file later on:</p>
<div class="highlight"><pre><span></span>(venv) [bobbelderbos@imac tips_api (master)]$ deactivate
[bobbelderbos@imac tips_api (master)]$ vi venv/bin/activate
...
export SECRET_KEY=&#39;some-secret-string&#39;
export DEBUG=True
</pre></div>


<p>Then activate the venv:</p>
<div class="highlight"><pre><span></span>[bobbelderbos@imac tips_api (master)]$ source venv/bin/activate
(venv) [bobbelderbos@imac tips_api (master)]$
</pre></div>


<p>It's also important to set <code>ALLOWED_HOSTS</code>, but as we will see later I have it default to localhost which is fine for my local env.</p>
<h2>Create a Django project and app</h2>
<p>Let's make a Django project in the current directory (<code>.</code>):</p>
<div class="highlight"><pre><span></span>(venv) [bobbelderbos@imac tips_api]$ django-admin.py startproject tips .
</pre></div>


<p>Ignoring my virtual env folder, Django created this minimalistic project folder structure, <em>tips</em> being our main app:</p>
<div class="highlight"><pre><span></span>$ tree -I venv
.
├── manage.py
├── requirements.txt
└── tips
    ├── __init__.py
    ├── settings.py
    ├── urls.py
    └── wsgi.py

<span class="m">1</span> directory, <span class="m">6</span> files
</pre></div>


<p>And let's make our api <em>app</em> to keep it isolated from the rest:</p>
<div class="highlight"><pre><span></span>(venv) [bobbelderbos@imac tips_api]$ django-admin.py startapp api
(venv) [bobbelderbos@imac tips_api]$ tree -I venv
.
├── api
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── migrations
│   │   └── __init__.py
│   ├── models.py
│   ├── tests.py
│   └── views.py
...
</pre></div>


<p>Lastly we need to tell Django about both apps in <code>tips/settings.py</code> -&gt; <code>INSTALLED_APPS</code>. We also add <code>rest_framework</code> here for later use:</p>
<div class="highlight"><pre><span></span>INSTALLED_APPS = [
    ...
    &#39;rest_framework&#39;,
    ...
    &#39;tips&#39;,
    &#39;api&#39;,
]
</pre></div>


<h3>The model</h3>
<p>Looking at the original model on our platform we see the following fields:</p>
<p><img alt="design" src="https://pybit.es/images/django-rest-digital-ocean/design.png"></p>
<p>As we saw <a href="https://pybit.es/python-tips-carbon-selenium.html">last time</a> the <code>share_link</code> is to be populated by an admin when we share out a tip with a nice <a href="https://carbon.now.sh">carbon</a> image.</p>
<p>Let's build our model <code>tips/models.py</code> using these fields. </p>
<p>I am also creating an <code>Author</code> model to store Twitter and Slack handles from future contributing users. The former to give credit when we share their tips on Twitter, the latter to store the author of the tip when we start receiving them from Slack (next article).</p>
<p>Thinking about (predicting) tomorrow's requirement is one of the fascinating things about software development!</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.db.models.signals</span> <span class="kn">import</span> <span class="n">post_save</span>
<span class="kn">from</span> <span class="nn">django.dispatch</span> <span class="kn">import</span> <span class="n">receiver</span>


<span class="k">class</span> <span class="nc">Tip</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">tip</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">link</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c1"># set by admin</span>
    <span class="n">approved</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">share_link</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">URLField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">added</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">edited</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Author</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extending the standard User model:</span>
<span class="sd">    https://simpleisbetterthancomplex.com/tutorial/2016/07/22/how-to-extend-django-user-model.html</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">slack_handle</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">twitter_handle</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>


<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">create_user_author</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">created</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">created</span><span class="p">:</span>
        <span class="n">Author</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="n">instance</span><span class="p">)</span>


<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_save</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">User</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">save_user_author</span><span class="p">(</span><span class="n">sender</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">instance</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>


<p>The <code>Tip</code> model should be pretty straightforward. Note the <code>User</code> ForeignKey in <code>Tip</code> to give them <em>owners</em>.</p>
<p>I added <code>@receiver</code>s to Django's native <code>User</code> model to detect when a new user gets created. When that happens a new <code>Author</code> instance is created as well.</p>
<p>This is one way to extend Django's <code>User</code> model which I learned about <a href="https://simpleisbetterthancomplex.com/tutorial/2016/07/22/how-to-extend-django-user-model.html">here</a>. </p>
<p>Now it's time to make the migration files and migrate (sync) the two new models to the database.</p>
<p>As it's the first time we call <code>migrate</code> all models that come with Django out of the box, get synced to the DB as well. I am using the default <code>sqlite3</code> DB for now, but I should probably change that to Postgres to mirror deployment to Digital Ocean.</p>
<div class="highlight"><pre><span></span>(venv) [bobbelderbos@imac tips_api (master)]$ python manage.py makemigrations tips
Migrations for &#39;tips&#39;:
tips/migrations/0001_initial.py
    - Create model Author
    - Create model Tip

(venv) [bobbelderbos@imac tips_api (master)]$ python manage.py migrate
Operations to perform:
Apply all migrations: admin, auth, contenttypes, sessions, tips
Running migrations:
Applying contenttypes.0001_initial... OK
Applying auth.0001_initial... OK
Applying admin.0001_initial... OK
Applying admin.0002_logentry_remove_auto_add... OK
Applying admin.0003_logentry_add_action_flag_choices... OK
Applying contenttypes.0002_remove_content_type_name... OK
Applying auth.0002_alter_permission_name_max_length... OK
Applying auth.0003_alter_user_email_max_length... OK
Applying auth.0004_alter_user_username_opts... OK
Applying auth.0005_alter_user_last_login_null... OK
Applying auth.0006_require_contenttypes_0002... OK
Applying auth.0007_alter_validators_add_error_messages... OK
Applying auth.0008_alter_user_username_max_length... OK
Applying auth.0009_alter_user_last_name_max_length... OK
Applying sessions.0001_initial... OK
Applying tips.0001_initial... OK
</pre></div>


<p>Let's create a <code>superuser</code> <em>pybites</em> to access the app and see if the <code>Author</code> entry was created as well</p>
<div class="highlight"><pre><span></span>$ python manage.py createsuperuser
Username <span class="o">(</span>leave blank to use <span class="s1">&#39;bobbelderbos&#39;</span><span class="o">)</span>: pybites
Email address:
Password:
Password <span class="o">(</span>again<span class="o">)</span>:
Superuser created successfully.
</pre></div>


<p>Great: that created both a <code>User</code> and an <code>Author</code> instance in our DB. I am using <a href="https://sqlitebrowser.org">DB Browser for SQLite</a> to query my local DB here:</p>
<p><img alt="auth user" src="https://pybit.es/images/django-rest-digital-ocean/auth_user.png"></p>
<p><img alt="tips author" src="https://pybit.es/images/django-rest-digital-ocean/tips_author.png"></p>
<h2>Import Tips from our Platform</h2>
<p>Next we want to retrieve the tips <a href="https://codechalleng.es/tips">currently on our platform</a> so I coded up a <a href="https://docs.djangoproject.com/en/2.1/howto/custom-management-commands/">Django command</a> to parse them and save them to our new tips Database. </p>
<div class="highlight"><pre><span></span>(venv) [bobbelderbos@imac tips_api (master)]$ cd tips/
(venv) [bobbelderbos@imac tips (master)]$ mkdir -p management/commands
(venv) [bobbelderbos@imac tips (master)]$ cd $_
(venv) [bobbelderbos@imac commands (master)]$ vi sync_tips.py
</pre></div>


<p>Here is the code I mostly re-used from last week's article: <a href="https://pybit.es/python-tips-carbon-selenium.html">Generating Beautiful Code Snippets with Carbon and Selenium</a>:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>
<span class="kn">import</span> <span class="nn">requests</span>

<span class="kn">from</span> <span class="nn">django.contrib.auth.models</span> <span class="kn">import</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">django.core.management.base</span> <span class="kn">import</span> <span class="n">BaseCommand</span>

<span class="kn">from</span> <span class="nn">tips.models</span> <span class="kn">import</span> <span class="n">Tip</span>

<span class="n">PYBITES</span> <span class="o">=</span> <span class="s1">&#39;pybites&#39;</span>
<span class="n">PYBITES_HAS_TWEETED</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{PYBITES}/status&#39;</span>
<span class="n">TIPS_PAGE</span> <span class="o">=</span> <span class="s1">&#39;https://codechalleng.es/tips&#39;</span>


<span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">BaseCommand</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Quick and dirty, using bs4 from last article:</span>
<span class="sd">    https://github.com/pybites/blog_code/blob/master/tips/tips.py</span>

<span class="sd">    About django-admin commands:</span>
<span class="sd">    https://docs.djangoproject.com/en/2.1/howto/custom-management-commands/</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">help</span> <span class="o">=</span> <span class="s1">&#39;Script to insert pybites tips from platform&#39;</span>

    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">username</span><span class="o">=</span><span class="n">PYBITES</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">User</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Cannot run this without SU pybites&#39;</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>

        <span class="n">html</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">TIPS_PAGE</span><span class="p">)</span>
        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">html</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">)</span>
        <span class="n">trs</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s2">&quot;tr&quot;</span><span class="p">)</span>

        <span class="n">new_tips_created</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">trs</span><span class="p">:</span>
            <span class="n">tds</span> <span class="o">=</span> <span class="n">tr</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;td&quot;</span><span class="p">)</span>
            <span class="n">tip_html</span> <span class="o">=</span> <span class="n">tds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">links</span> <span class="o">=</span> <span class="n">tip_html</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">class_</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="n">first_link</span> <span class="o">=</span> <span class="n">links</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">)</span>

            <span class="n">pre</span> <span class="o">=</span> <span class="n">tip_html</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;pre&quot;</span><span class="p">)</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">pre</span> <span class="ow">and</span> <span class="n">pre</span><span class="o">.</span><span class="n">text</span> <span class="ow">or</span> <span class="bp">None</span>

            <span class="n">share_link</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">PYBITES_HAS_TWEETED</span> <span class="ow">in</span> <span class="n">first_link</span><span class="p">:</span>
                <span class="n">share_link</span> <span class="o">=</span> <span class="n">first_link</span>

            <span class="n">tip</span> <span class="o">=</span> <span class="n">tip_html</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;blockquote&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">text</span>
            <span class="n">src</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">links</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">links</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;href&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">None</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">created</span> <span class="o">=</span> <span class="n">Tip</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get_or_create</span><span class="p">(</span><span class="n">tip</span><span class="o">=</span><span class="n">tip</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
                                                   <span class="n">link</span><span class="o">=</span><span class="n">src</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                                                   <span class="n">approved</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                                   <span class="n">share_link</span><span class="o">=</span><span class="n">share_link</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">created</span><span class="p">:</span>
                <span class="n">new_tips_created</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Done: {new_tips_created} tips imported&#39;</span><span class="p">)</span>
</pre></div>


<p>It scrapes the page with <code>requests</code> and <code>BeautifulSoup</code>. Originally I kept a list of <code>Tip</code> objects and used Django's ORM <code>bulk_create</code> method to write them to the DB in one transaction which is neat. </p>
<p>However I found it nicer to make it work like an update script, in case the platform gets new tips in the interim. Calling the script again should just insert the newer tips.</p>
<p>For that reason I went with Django's handy <code>Tip.objects.get_or_create</code> which will create the tip if nothing matches the <code>kwargs</code> passed in, otherwise it will return the object (which I ignore using <code>_</code>). This way it will only create a tip if not already in the DB. </p>
<p>Let's run this:</p>
<div class="highlight"><pre><span></span>(venv) [bobbelderbos@imac tips_api (master)]$ python manage.py sync_tips
Done: 92 tips imported
</pre></div>


<p><img alt="tips imported" src="https://pybit.es/images/django-rest-digital-ocean/import.png"></p>
<p><img alt="a single tip" src="https://pybit.es/images/django-rest-digital-ocean/import2.png"></p>
<p>Awesome: we have our tips in the DB and you now know how to write a Django Command! Just extend <code>BaseCommand</code>, implement <code>handle</code> and save the script in a subdirectory called <code>management/commands</code> in your app folder.</p>
<h2>Build an API with Django REST Framework</h2>
<p>Let's build the API next. We already added <code>rest_framework</code> to <code>INSTALLED_APPS</code>. Let's also set the <a href="https://www.django-rest-framework.org/api-guide/permissions/">permissions</a> to <code>DjangoModelPermissionsOrAnonReadOnly</code> which seems to match what we want:</p>
<blockquote>
<p>Similar to <code>DjangoModelPermissions</code> (permission class ties into Django's standard <code>django.contrib.auth</code> model permissions), but also allows unauthenticated users to have read-only access to the API.</p>
</blockquote>
<p>In <code>tips/settings.py</code> I am adding the <code>REST_FRAMEWORK dict</code>, setting <code>DEFAULT_PERMISSION_CLASSES</code>:</p>
<div class="highlight"><pre><span></span>REST_FRAMEWORK = {
    # Use Django&#39;s standard `django.contrib.auth` permissions,
    # or allow read-only access for unauthenticated users.
    &#39;DEFAULT_PERMISSION_CLASSES&#39;: [
        &#39;rest_framework.permissions.DjangoModelPermissionsOrAnonReadOnly&#39;
    ]
}
</pre></div>


<h3>Serializers</h3>
<p>Next we need a serializer which <a href="https://www.django-rest-framework.org/api-guide/serializers/">Django REST</a> defines as:</p>
<blockquote>
<p>Serializers allow complex data such as querysets and model instances to be converted to native Python datatypes that can then be easily rendered into JSON, XML or other content types. Serializers also provide deserialization, allowing parsed data to be converted back into complex types, after first validating the incoming data.</p>
</blockquote>
<p>In <code>api/serializers.py</code> I added this code which should look familiar if you have worked with the <a href="https://docs.djangoproject.com/en/2.0/topics/forms/">Django Form</a> class:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">serializers</span>

<span class="kn">from</span> <span class="nn">tips.models</span> <span class="kn">import</span> <span class="n">Tip</span>


<span class="k">class</span> <span class="nc">TipSerializer</span><span class="p">(</span><span class="n">serializers</span><span class="o">.</span><span class="n">ModelSerializer</span><span class="p">):</span>
    <span class="n">author</span> <span class="o">=</span> <span class="n">serializers</span><span class="o">.</span><span class="n">RelatedField</span><span class="p">(</span><span class="n">read_only</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Tip</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;tip&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;link&#39;</span><span class="p">,</span> <span class="s1">&#39;author&#39;</span><span class="p">,</span> <span class="s1">&#39;approved&#39;</span><span class="p">,</span> <span class="s1">&#39;share_link&#39;</span><span class="p">)</span>
</pre></div>


<p>You probably don't have to define <code>fields</code> if you want them all, but being explicit is usually not a bad thing.</p>
<h3>Views</h3>
<p>Next the views. Again Django REST Framework's great level of abstraction saves us a lot of boilerplate code. We can just extend some useful classes defined in <code>generics</code>:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">generics</span>

<span class="kn">from</span> <span class="nn">tips.models</span> <span class="kn">import</span> <span class="n">Tip</span>
<span class="kn">from</span> <span class="nn">.serializers</span> <span class="kn">import</span> <span class="n">TipSerializer</span>
<span class="kn">from</span> <span class="nn">.permissions</span> <span class="kn">import</span> <span class="n">IsOwnerOrReadOnly</span>


<span class="k">class</span> <span class="nc">TipList</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">ListCreateAPIView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get:</span>
<span class="sd">    Return a list of all tips in the DB.</span>

<span class="sd">    post:</span>
<span class="sd">    Create an awesome new tip.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Tip</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">TipSerializer</span>


<span class="k">class</span> <span class="nc">TipDetail</span><span class="p">(</span><span class="n">generics</span><span class="o">.</span><span class="n">RetrieveUpdateDestroyAPIView</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    get:</span>
<span class="sd">    Return an individual tip.</span>

<span class="sd">    put:</span>
<span class="sd">    Update an existing tip.</span>

<span class="sd">    delete:</span>
<span class="sd">    Delete a single tip.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">IsOwnerOrReadOnly</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">queryset</span> <span class="o">=</span> <span class="n">Tip</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="n">serializer_class</span> <span class="o">=</span> <span class="n">TipSerializer</span>
</pre></div>


<p>Note that I structured the <em>docstrings</em> in a way to easily add documentation using a tool like <a href="https://swagger.io/">Swagger</a> in the future.</p>
<h3>Permissions</h3>
<p>In the <code>TipDetail</code> view we defined a customized <em>permission class</em> called <code>IsOwnerOrReadOnly</code> which we need to define next in <code>api/permissions.py</code> (code from second example <a href="https://www.django-rest-framework.org/api-guide/permissions/#examples">here</a>).</p>
<p>The following code in that module will grant read access to any safe methods (<code>GET</code>, <code>OPTIONS</code> and <code>HEAD</code>) and edit right for users that have authored ("own") tips. </p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">rest_framework</span> <span class="kn">import</span> <span class="n">permissions</span>


<span class="k">class</span> <span class="nc">IsOwnerOrReadOnly</span><span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">BasePermission</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Make sure only owners of tips can edit them.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">has_object_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">view</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="c1"># Read permissions are allowed to any request,</span>
        <span class="c1"># so we&#39;ll always allow GET, HEAD or OPTIONS requests.</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="n">permissions</span><span class="o">.</span><span class="n">SAFE_METHODS</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>

        <span class="c1"># Instance must have an attribute named `owner`.</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
</pre></div>


<p><code>obj.user</code> refers to the <code>ForeignKey</code> we defined on the <code>Tip</code> model:</p>
<div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">Tip</span><span class="p">(</span><span class="nx">models</span><span class="p">.</span><span class="nx">Model</span><span class="p">)</span><span class="o">:</span>
    <span class="p">...</span>
    <span class="nx">user</span> <span class="o">=</span> <span class="nx">models</span><span class="p">.</span><span class="nx">ForeignKey</span><span class="p">(</span><span class="nx">User</span><span class="p">,</span> <span class="nx">on_delete</span><span class="o">=</span><span class="nx">models</span><span class="p">.</span><span class="nx">CASCADE</span><span class="p">)</span>
</pre></div>


<h3>Routes</h3>
<p>And finally to be able to access the routes let's set up our <code>urlpatterns</code> in <code>api/urls.py</code>:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>

<span class="kn">from</span> <span class="nn">.views</span> <span class="kn">import</span> <span class="n">TipList</span><span class="p">,</span> <span class="n">TipDetail</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">TipList</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;&lt;int:pk&gt;&#39;</span><span class="p">,</span> <span class="n">TipDetail</span><span class="o">.</span><span class="n">as_view</span><span class="p">()),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;admin/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;rest_framework.urls&#39;</span><span class="p">)),</span>
<span class="p">]</span>
</pre></div>


<p>And in the main app's router file (<code>tips/urls.py</code>) include the <code>api</code> one like this:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span><span class="p">,</span> <span class="n">include</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;api/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;api.urls&#39;</span><span class="p">)),</span>
<span class="p">]</span>
</pre></div>


<p>And that's it! Let's launch the server and check out our new API next ...</p>
<div class="highlight"><pre><span></span>(venv) [bobbelderbos@imac tips_api (master)]$ python manage.py runserver
...
Starting development server at http://127.0.0.1:8000/
</pre></div>


<h2>Verify it works</h2>
<p>We can consume our API with various tools:</p>
<h3><code>curl</code></h3>
<p>Nice and easy:</p>
<div class="highlight"><pre><span></span>[bobbelderbos@imac ~]$ curl http://127.0.0.1:8000/api/4
{&quot;tip&quot;:&quot;Q: difference between __str__ and __repr__ in #Python? A: \&quot;My rule of thumb:  __repr__ is for developers, __str__ is for customers.\&quot; (Ned Batchelder on SO)&quot;,&quot;code&quot;:null,&quot;link&quot;:&quot;https://stackoverflow.com/a/1438297&quot;,&quot;user&quot;:1,&quot;approved&quot;:true,&quot;share_link&quot;:null}
</pre></div>


<h3>Postman</h3>
<p><em>Postman Simplifies API Development</em>. You can download it <a href="https://www.getpostman.com/">here</a>.</p>
<p>Get all tips:</p>
<p><img alt="get all tips" src="https://pybit.es/images/django-rest-digital-ocean/postman-get-all.png"></p>
<p>Get a single tip:</p>
<p><img alt="get single tip" src="https://pybit.es/images/django-rest-digital-ocean/postman-get-one.png"></p>
<p>Verify I cannot post without login:</p>
<p><img alt="cannot post" src="https://pybit.es/images/django-rest-digital-ocean/postman-post.png"></p>
<h3>Django REST Framework</h3>
<p>Django REST provides a really nice browser interface to play with our new API:</p>
<p><img alt="Django rest front-end" src="https://pybit.es/images/django-rest-digital-ocean/django-rest-browser1.png"></p>
<p>As I am an <em>anonymous</em> user I don't see any edit options:</p>
<p><img alt="Django rest front-end" src="https://pybit.es/images/django-rest-digital-ocean/django-rest-browser2.png"></p>
<p>When I log in as my <em>superuser</em> though, a form and delete button show up:</p>
<p><img alt="Django rest front-end" src="https://pybit.es/images/django-rest-digital-ocean/django-rest-browser3.png"></p>
<p>Navigating back to the root of the API, I can also <code>POST</code> a new tip now that I am logged in:</p>
<p><img alt="Django rest front-end" src="https://pybit.es/images/django-rest-digital-ocean/django-rest-browser4.png"></p>
<h3>Tests</h3>
<p>Ideally we'd write some tests at this point to future-proof any changes we have to make to our API. I leave that as an exercise (challenge) for the reader though. You can PR your code for this challenge <a href="https://codechalleng.es/challenges/39/">here</a>. We did a similar exercise <a href="https://pybit.es/simple-flask-api.html">here</a>.</p>
<hr>
<h2>Deploy the API to Digital Ocean</h2>
<p>I got 100 bucks credit for free via <a href="https://pythonbytes.fm/">Python Bytes</a> - nice, thanks!</p>
<h3>Fresh install</h3>
<p>My first attempt (cause <em>programmers are supposed to be lazy</em>, right?!) was to go with the <a href="https://www.digitalocean.com/docs/one-clicks/django/">Django One-Click Application</a>:</p>
<p><img alt="Django droplet" src="https://pybit.es/images/django-rest-digital-ocean/django-droplet1.png"></p>
<p><img alt="Django droplet" src="https://pybit.es/images/django-rest-digital-ocean/django-droplet2.png"></p>
<p>However the <a href="https://packages.ubuntu.com/bionic/python-django">latest Django from APT</a> is 1.11 at this time and our API uses Django 2.x so let's set everything up from scratch using a fresh Ubuntu 18.04 server instance. Not only do we get it exactly as we want, it's also a nice learning exercise!</p>
<p><img alt="new Ubuntu instance" src="https://pybit.es/images/django-rest-digital-ocean/ubuntu1804.png"></p>
<h3>SSH access and keys</h3>
<p>First hurdle you might find is not being able to SSH in as root (I should have remembered this from my old SunOS days ...):</p>
<div class="highlight"><pre><span></span><span class="err">$</span> <span class="n">ssh</span> <span class="n">root</span><span class="mf">@159.203.186.209</span>
<span class="n">root</span><span class="mf">@159.203.186.209</span><span class="o">:</span> <span class="n">Permission</span> <span class="n">denied</span> <span class="p">(</span><span class="n">publickey</span><span class="p">).</span>
</pre></div>


<p><code>PermitRootLogin</code> was already set to <code>yes</code> in <code>/etc/ssh/sshd_config</code>, but I also had to set <code>PasswordAuthentication</code> to <code>yes</code> opening a Console session from Digital Ocean's BUI, followed by a <code>sudo service ssh restart</code>. Now I was able to SSH in as root.</p>
<p>I <a href="https://www.digitalocean.com/docs/droplets/how-to/add-ssh-keys/to-account/">uploaded a SSH public key</a> to Digital Ocean's account page and had it added to the droplet upon creaton. This populated <code>~/.ssh/authorized_keys</code> with my public key.</p>
<p>Locally I then made an alias in <code>.ssh/config</code> to be able to login using the alias <code>ssh dioc</code>:</p>
<div class="highlight"><pre><span></span>Host dioc
HostName 159.203.186.209
User root
IdentityFile ~/.ssh/DO
</pre></div>


<p>(Where <code>/.ssh/DO</code> is my private key stored locally.)</p>
<h3>Upgrade</h3>
<p>Best practice is to first upgrade the OS because it was behind on important security fixes. This required a reboot:</p>
<div class="highlight"><pre><span></span>root@ubuntu-s-1vcpu-1gb-nyc1-01:~# apt-get update &amp;&amp; apt-get -y upgrade
root@ubuntu-s-1vcpu-1gb-nyc1-01:~# reboot
</pre></div>


<p>Logging in again I followed Digital Ocean's <a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04">Initial Server Setup with Ubuntu 18.04</a> creating a user: <code>adduser bob</code> and granting <code>sudo</code> rights: <code>usermod -aG sudo bob</code></p>
<h3>Firewall</h3>
<p>Next I enabled the firewall:</p>
<div class="highlight"><pre><span></span>root@ubuntu-s-1vcpu-1gb-nyc1-01:~# ufw app list
Available applications:
OpenSSH
root@ubuntu-s-1vcpu-1gb-nyc1-01:~# ufw allow OpenSSH
Rules updated
Rules updated (v6)
root@ubuntu-s-1vcpu-1gb-nyc1-01:~# ufw enable
Command may disrupt existing ssh connections. Proceed with operation (y|n)? y
Firewall is active and enabled on system startup
root@ubuntu-s-1vcpu-1gb-nyc1-01:~# ufw status
Status: active

To                         Action      From
--                         ------      ----
OpenSSH                    ALLOW       Anywhere
OpenSSH (v6)               ALLOW       Anywhere (v6)
</pre></div>


<h3>SSH part II</h3>
<p>Next I made sure my new user (<code>bob</code>) could login as well.</p>
<p>As I use SSH keys for logging in as root, I copied over the <code>.ssh</code> folder to my new user's home folder using <code>rsync</code>:</p>
<div class="highlight"><pre><span></span>root@ubuntu-s-1vcpu-1gb-nyc1-01:~# rsync --archive --chown=bob:bob ~/.ssh /home/bob
root@ubuntu-s-1vcpu-1gb-nyc1-01:~# ls -l  /home/bob/.ssh/authorized_keys
-rw------- 1 bob bob 410 Mar  3 07:40 /home/bob/.ssh/authorized_keys
</pre></div>


<p>And locally I made a new SSH shortcut in <code>.ssh/config</code>:</p>
<div class="highlight"><pre><span></span>Host diocu
HostName 159.203.186.209
User bob
IdentityFile ~/.ssh/DO
</pre></div>


<p>At this point <code>bob</code> could SSH in using the alias <code>ssh diocu</code>:</p>
<div class="highlight"><pre><span></span>(venv) [bobbelderbos@imac tips_api (master)]$ ssh diocu
Welcome to Ubuntu 18.04.2 LTS (GNU/Linux 4.15.0-45-generic x86_64)
...
To run a command as administrator (user &quot;root&quot;), use &quot;sudo &lt;command&gt;&quot;.
See &quot;man sudo_root&quot; for details.

bob@ubuntu-s-1vcpu-1gb-nyc1-01:~$
</pre></div>


<p>Next I followed Digital Ocean's useful article: <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-django-with-postgres-nginx-and-gunicorn-on-ubuntu-18-04">How To Set Up Django with Postgres, Nginx, and Gunicorn on Ubuntu 18.04</a>.</p>
<p>This guide shows you how to install Django within a virtual environment which I think is the best way to go, <em>Namespaces are one honking great idea -- let's do more of those!</em> (Zen of Python)</p>
<p>What follows is mostly the same as the steps outlined in that guide, but through the lens of me doing it for our API. </p>
<h3>Python 3</h3>
<p>First we need to install the following packages, upgrade <code>pip</code> and grab <code>virtualenv</code>. Note I logged in as <code>bob</code> so any <em>admin</em> commands need to be preceded by <code>sudo</code>:</p>
<div class="highlight"><pre><span></span>sudo apt update
sudo apt install python3-pip python3-dev libpq-dev postgresql postgresql-contrib nginx curl
sudo -H pip3 install --upgrade pip
sudo -H pip3 install virtualenv
</pre></div>


<h3>Database</h3>
<p>We want to use a postgres DB and user:</p>
<div class="highlight"><pre><span></span>sudo -u postgres psql
postgres=# CREATE DATABASE tips;
CREATE DATABASE
postgres=# CREATE USER pybites WITH PASSWORD &#39;something-secure&#39;;
CREATE ROLE
postgres=# ALTER ROLE pybites SET client_encoding TO &#39;utf8&#39;;
ALTER ROLE
postgres=# ALTER ROLE pybites SET default_transaction_isolation TO &#39;read committed&#39;;
ALTER ROLE
postgres=# ALTER ROLE pybites SET timezone TO &#39;UTC&#39;;
ALTER ROLE
postgres=# GRANT ALL PRIVILEGES ON DATABASE tips TO pybites;
GRANT
postgres=# \q
</pre></div>


<h3>Pull in the Django API code</h3>
<p>Not part of the guide, but at this point I pulled in our code from Github saving it to my <code>$HOME</code> folder:</p>
<div class="highlight"><pre><span></span>git clone https://github.com/pybites/tips_api
cd tips_api
</pre></div>


<h3>Settings</h3>
<p>I added this to the venv's activation script, to run the dev server (<code>gunicorn</code> won't use these though as we will see in a bit):</p>
<div class="highlight"><pre><span></span>$ vi venv/bin/activate
...
<span class="nb">export</span> <span class="nv">SECRET_KEY</span><span class="o">=</span><span class="s1">&#39;xyz&#39;</span>
<span class="nb">export</span> <span class="nv">DEBUG</span><span class="o">=</span>True
<span class="nb">export</span> <span class="nv">ALLOWED_HOSTS</span><span class="o">=</span><span class="s1">&#39;localhost, 159.203.186.209&#39;</span>
<span class="nb">export</span> <span class="nv">DB_ENGINE</span><span class="o">=</span><span class="s1">&#39;django.db.backends.postgresql_psycopg2&#39;</span>
<span class="nb">export</span> <span class="nv">DB_NAME</span><span class="o">=</span><span class="s1">&#39;tips&#39;</span>
<span class="nb">export</span> <span class="nv">DB_USER</span><span class="o">=</span><span class="s1">&#39;pybites&#39;</span>
<span class="nb">export</span> <span class="nv">DB_PASSWORD</span><span class="o">=</span><span class="s1">&#39;something-secure&#39;</span>

$ <span class="nb">source</span> venv/bin/activate
</pre></div>


<p>These are referenced in Django's <code>tips/settings.py</code> with sensible defaults if omitted:</p>
<div class="highlight"><pre><span></span>ALLOWED_HOSTS = os.environ.get(&#39;ALLOWED_HOSTS&#39;, &#39;localhost&#39;).split(&#39;, &#39;)
...
DATABASES = {
    &#39;default&#39;: {
        &#39;ENGINE&#39;: os.environ.get(&#39;DB_ENGINE&#39;, &#39;django.db.backends.sqlite3&#39;),  # default sqlite3 if desired
        &#39;NAME&#39;: os.environ.get(&#39;DB_NAME&#39;, os.path.join(BASE_DIR, &#39;db.sqlite3&#39;)),
        &#39;USER&#39;: os.environ.get(&#39;DB_USER&#39;, &#39;&#39;),
        &#39;PASSWORD&#39;: os.environ.get(&#39;DB_PASSWORD&#39;, &#39;&#39;),
        &#39;HOST&#39;: os.environ.get(&#39;DB_HOST&#39;, &#39;localhost&#39;),
        &#39;PORT&#39;: os.environ.get(&#39;DB_PORT&#39;, &#39;&#39;),  # can leave empty on Digital Ocean
    }
}
</pre></div>


<h3>Dependencies</h3>
<p>With my venv enabled let's install the dependencies:</p>
<div class="highlight"><pre><span></span>(venv) bob@ubuntu-s-1vcpu-1gb-nyc1-01:~/tips_api$ pip install -r requirements.txt
...
(venv) bob@ubuntu-s-1vcpu-1gb-nyc1-01:~/tips_api$ pip freeze
beautifulsoup4==4.7.1
bs4==0.0.1
certifi==2018.11.29
chardet==3.0.4
Django==2.1.7
djangorestframework==3.9.1
gunicorn==19.9.0
idna==2.8
psycopg2==2.7.7
psycopg2-binary==2.7.7
pytz==2018.9
requests==2.21.0
soupsieve==1.8
urllib3==1.24.1
</pre></div>


<h3>Static files</h3>
<p>To support static file handling by Nginx we need to set the following two constants in <code>tips/settings.py</code>:</p>
<div class="highlight"><pre><span></span>STATIC_URL = &#39;/static/&#39;
STATIC_ROOT = os.path.join(BASE_DIR, &#39;static/&#39;)
</pre></div>


<h3>Sync the DB</h3>
<p>Next we sync the models/migrations to the newly created postgres DB:</p>
<div class="highlight"><pre><span></span>(venv) bob@ubuntu-s-1vcpu-1gb-nyc1-01:~/tips_api$ python manage.py migrate
Operations to perform:
Apply all migrations: admin, auth, contenttypes, sessions, tips
Running migrations:
Applying contenttypes.0001_initial... OK
Applying auth.0001_initial... OK
Applying admin.0001_initial... OK
Applying admin.0002_logentry_remove_auto_add... OK
Applying admin.0003_logentry_add_action_flag_choices... OK
Applying contenttypes.0002_remove_content_type_name... OK
Applying auth.0002_alter_permission_name_max_length... OK
Applying auth.0003_alter_user_email_max_length... OK
Applying auth.0004_alter_user_username_opts... OK
Applying auth.0005_alter_user_last_login_null... OK
Applying auth.0006_require_contenttypes_0002... OK
Applying auth.0007_alter_validators_add_error_messages... OK
Applying auth.0008_alter_user_username_max_length... OK
Applying auth.0009_alter_user_last_name_max_length... OK
Applying sessions.0001_initial... OK
Applying tips.0001_initial... OK
Applying tips.0002_auto_20190302_1958... OK
Applying tips.0003_auto_20190302_2011... OK
</pre></div>


<p>Great!</p>
<p>Note that Django migrations are committed to source code so I did not have to generate them (<code>makemigrations</code>) again!</p>
<h3>Superuser</h3>
<p>Let's create our <code>pybites</code> admin to pull in our existing tips:</p>
<div class="highlight"><pre><span></span>(venv) bob@ubuntu-s-1vcpu-1gb-nyc1-01:~/tips_api$ python manage.py createsuperuser
Username (leave blank to use &#39;bob&#39;): pybites
Email address:
Password:
Password (again):
Superuser created successfully.
</pre></div>


<p>And import the tips from our platform:</p>
<div class="highlight"><pre><span></span>(venv) bob@ubuntu-s-1vcpu-1gb-nyc1-01:~/tips_api$ python manage.py sync_tips
Done: 92 tips imported
</pre></div>


<p>Perfect. Let's collect the static files (<em>but it's an API?</em> you might ask ... well, Django's Admin back-end and Django REST Framework's browser UI use quite a few static files!)</p>
<div class="highlight"><pre><span></span>(venv) bob@ubuntu-s-1vcpu-1gb-nyc1-01:~/tips_api$ python manage.py collectstatic
155 static files copied to &#39;/home/bob/tips_api/static&#39;.

(venv) bob@ubuntu-s-1vcpu-1gb-nyc1-01:~/tips_api$ ls static/
admin  rest_framework
</pre></div>


<h3>Dev server</h3>
<p>To run the development server have the firewall grant access to port 8000:</p>
<div class="highlight"><pre><span></span>(venv) bob@ubuntu-s-1vcpu-1gb-nyc1-01:~/tips_api$ sudo ufw allow 8000
[sudo] password for bob:
Rule added
Rule added (v6)
</pre></div>


<p>And now we can run the development server: </p>
<div class="highlight"><pre><span></span>(venv) bob@ubuntu-s-1vcpu-1gb-nyc1-01:~/tips_api$ python manage.py runserver 0.0.0.0:8000
Performing system checks...

System check identified no issues (0 silenced).
March 04, 2019 - 09:05:00
Django version 2.1.7, using settings &#39;tips.settings&#39;
Starting development server at http://0.0.0.0:8000/
Quit the server with CONTROL-C.
</pre></div>


<p>Browsing to <code>http://159.203.186.209:8000/api/</code> we see:</p>
<p><img alt="api from dev server" src="https://pybit.es/images/django-rest-digital-ocean/remote-api-dev-server.png"></p>
<p>Awesome! Well, actually first I got a permission error because I only had <em>localhost</em> in <code>ALLOWED_HOSTS</code> so make sure you add your own IP. Again in this case that is <code>159.203.186.209</code>.</p>
<h3>Gunicorn</h3>
<p>Now let's use Gunicorn. First test it manually:</p>
<div class="highlight"><pre><span></span>(venv) bob@ubuntu-s-1vcpu-1gb-nyc1-01:~/tips_api$ gunicorn --bind 0.0.0.0:8000 tips.wsgi
[2019-03-04 09:11:10 +0000] [16579] [INFO] Starting gunicorn 19.9.0
[2019-03-04 09:11:10 +0000] [16579] [INFO] Listening at: http://0.0.0.0:8000 (16579)
[2019-03-04 09:11:10 +0000] [16579] [INFO] Using worker: sync
[2019-03-04 09:11:10 +0000] [16582] [INFO] Booting worker with pid: 16582
</pre></div>


<p>Next we make it persistent with a <em>socket</em>:</p>
<blockquote>
<p>The Gunicorn socket will be created at boot and will listen for connections. When a connection occurs, systemd will automatically start the Gunicorn process to handle the connection.</p>
</blockquote>
<div class="highlight"><pre><span></span>bob@ubuntu-s-1vcpu-1gb-nyc1-01:~/tips_api$ sudo vi /etc/systemd/system/gunicorn.socket
</pre></div>


<p>Add this:</p>
<div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">gunicorn socket</span>

<span class="k">[Socket]</span>
<span class="na">ListenStream</span><span class="o">=</span><span class="s">/run/gunicorn.sock</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">sockets.target</span>
</pre></div>


<p>Then create a <code>gunicorn.service</code>:</p>
<div class="highlight"><pre><span></span>bob@ubuntu-s-1vcpu-1gb-nyc1-01:~/tips_api$ sudo vi /etc/systemd/system/gunicorn.service
</pre></div>


<p>Adding:</p>
<div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">gunicorn daemon</span>
<span class="na">Requires</span><span class="o">=</span><span class="s">gunicorn.socket</span>
<span class="na">After</span><span class="o">=</span><span class="s">network.target</span>

<span class="k">[Service]</span>
<span class="na">User</span><span class="o">=</span><span class="s">bob</span>
<span class="na">Group</span><span class="o">=</span><span class="s">www-data</span>
<span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">/home/bob/tips_api</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/home/bob/tips_api/venv/bin/gunicorn \</span>
<span class="s">        -e SECRET_KEY=&#39;abc&#39; \</span>
<span class="s">        -e DEBUG=True \</span>
<span class="s">        -e ALLOWED_HOSTS=&#39;localhost, 159.203.186.209&#39; \</span>
<span class="s">        -e DB_ENGINE=&#39;django.db.backends.postgresql_psycopg2&#39; \</span>
<span class="s">        -e DB_NAME=&#39;tips&#39; \</span>
<span class="s">        -e DB_USER=&#39;pybites&#39; \</span>
<span class="s">        -e DB_PASSWORD=&#39;abc&#39; \</span>
<span class="s">        --access-logfile - \</span>
<span class="s">        --workers 3 \</span>
<span class="s">        --bind unix:/run/gunicorn.sock \</span>
<span class="s">        tips.wsgi:application</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>


<p>And here I had some trouble: Gunicorn did not pick up env variables so Django would not get its required <code>SECRET_KEY</code> etc.</p>
<p>As per <a href="https://www.digitalocean.com/community/questions/gunicorn-service-can-t-read-environment-variables">this thread</a> I tried <code>EnvironmentFile=/home/bob/.env</code> copying the variables from <code>venv/bin/activate</code> (argh). Even that did not work.</p>
<p>So I ended up with adding them with multiple <code>-e</code> flags making it less DRY, although as all runs through <code>gunicorn</code> we might just ditch them from <code>venv/bin/activate</code> altogether.</p>
<p>To set this in motion:</p>
<div class="highlight"><pre><span></span><span class="nt">bob</span><span class="p">@</span><span class="k">ubuntu-s-1vcpu-1gb-nyc1-01</span><span class="o">:~/</span><span class="nt">tips_api</span><span class="o">$</span> <span class="nt">sudo</span> <span class="nt">systemctl</span> <span class="nt">start</span> <span class="nt">gunicorn</span><span class="p">.</span><span class="nc">socket</span>
<span class="nt">bob</span><span class="p">@</span><span class="k">ubuntu-s-1vcpu-1gb-nyc1-01</span><span class="o">:~/</span><span class="nt">tips_api</span><span class="o">$</span> <span class="nt">sudo</span> <span class="nt">systemctl</span> <span class="nt">enable</span> <span class="nt">gunicorn</span><span class="p">.</span><span class="nc">socket</span>
<span class="nt">Created</span> <span class="nt">symlink</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">systemd</span><span class="o">/</span><span class="nt">system</span><span class="o">/</span><span class="nt">sockets</span><span class="p">.</span><span class="nc">target</span><span class="p">.</span><span class="nc">wants</span><span class="o">/</span><span class="nt">gunicorn</span><span class="p">.</span><span class="nc">socket</span> <span class="err">→</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">systemd</span><span class="o">/</span><span class="nt">system</span><span class="o">/</span><span class="nt">gunicorn</span><span class="p">.</span><span class="nc">socket</span><span class="o">.</span>

<span class="nt">bob</span><span class="p">@</span><span class="k">ubuntu-s-1vcpu-1gb-nyc1-01</span><span class="o">:~/</span><span class="nt">tips_api</span><span class="o">$</span> <span class="nt">sudo</span> <span class="nt">systemctl</span> <span class="nt">status</span> <span class="nt">gunicorn</span><span class="p">.</span><span class="nc">socket</span>
<span class="nt">Failed</span> <span class="nt">to</span> <span class="nt">dump</span> <span class="nt">process</span> <span class="nt">list</span><span class="o">,</span> <span class="nt">ignoring</span><span class="o">:</span> <span class="nt">No</span> <span class="nt">such</span> <span class="nt">file</span> <span class="nt">or</span> <span class="nt">directory</span>
<span class="err">●</span> <span class="nt">gunicorn</span><span class="p">.</span><span class="nc">socket</span> <span class="nt">-</span> <span class="nt">gunicorn</span> <span class="nt">socket</span>
<span class="nt">Loaded</span><span class="o">:</span> <span class="nt">loaded</span> <span class="o">(/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">systemd</span><span class="o">/</span><span class="nt">system</span><span class="o">/</span><span class="nt">gunicorn</span><span class="p">.</span><span class="nc">socket</span><span class="p">;</span> <span class="nt">enabled</span><span class="p">;</span> <span class="nt">vendor</span> <span class="nt">preset</span><span class="o">:</span> <span class="nt">enabled</span><span class="o">)</span>
<span class="nt">Active</span><span class="o">:</span> <span class="nt">active</span> <span class="o">(</span><span class="nt">listening</span><span class="o">)</span> <span class="nt">since</span> <span class="nt">Mon</span> <span class="nt">2019-03-04</span> <span class="nt">09</span><span class="p">:</span><span class="nd">18</span><span class="p">:</span><span class="nd">06</span> <span class="nt">UTC</span><span class="p">;</span> <span class="nt">21s</span> <span class="nt">ago</span>
<span class="nt">Listen</span><span class="o">:</span> <span class="o">/</span><span class="nt">run</span><span class="o">/</span><span class="nt">gunicorn</span><span class="p">.</span><span class="nc">sock</span> <span class="o">(</span><span class="nt">Stream</span><span class="o">)</span>
<span class="nt">CGroup</span><span class="o">:</span> <span class="o">/</span><span class="nt">system</span><span class="p">.</span><span class="nc">slice</span><span class="o">/</span><span class="nt">gunicorn</span><span class="p">.</span><span class="nc">socket</span>

<span class="nt">Mar</span> <span class="nt">04</span> <span class="nt">09</span><span class="p">:</span><span class="nd">18</span><span class="p">:</span><span class="nd">06</span> <span class="nt">ubuntu-s-1vcpu-1gb-nyc1-01</span> <span class="nt">systemd</span><span class="cp">[</span><span class="mi">1</span><span class="cp">]</span><span class="o">:</span> <span class="nt">Listening</span> <span class="nt">on</span> <span class="nt">gunicorn</span> <span class="nt">socket</span><span class="o">.</span>

<span class="nt">bob</span><span class="p">@</span><span class="k">ubuntu-s-1vcpu-1gb-nyc1-01</span><span class="o">:~/</span><span class="nt">tips_api</span><span class="o">$</span> <span class="nt">file</span> <span class="o">/</span><span class="nt">run</span><span class="o">/</span><span class="nt">gunicorn</span><span class="p">.</span><span class="nc">sock</span>
<span class="o">/</span><span class="nt">run</span><span class="o">/</span><span class="nt">gunicorn</span><span class="p">.</span><span class="nc">sock</span><span class="o">:</span> <span class="nt">socket</span>
</pre></div>


<p>By the way, when troubleshooting these kind of issues and when making changes to your <code>gunicorn</code> config, remember to restart both the <code>daemon</code> and the <code>gunicorn</code> service:</p>
<div class="highlight"><pre><span></span>bob@ubuntu-s-1vcpu-1gb-nyc1-01:~/tips_api$ sudo systemctl daemon-reload &amp;&amp; sudo systemctl restart gunicorn.socket gunicorn.service
</pre></div>


<h3>Nginx</h3>
<p>As per <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-django-with-postgres-nginx-and-gunicorn-on-ubuntu-18-04">Digital Ocean's guide</a> I needed to do the following to get Nginx running:</p>
<div class="highlight"><pre><span></span><span class="nt">bob</span><span class="p">@</span><span class="k">ubuntu-s-1vcpu-1gb-nyc1-01</span><span class="o">:~/</span><span class="nt">tips_api</span><span class="o">$</span> <span class="nt">sudo</span> <span class="nt">vi</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">nginx</span><span class="o">/</span><span class="nt">sites-available</span><span class="o">/</span><span class="nt">tips_api</span>

<span class="nt">server</span> <span class="p">{</span>
    <span class="nt">listen</span> <span class="nt">80</span><span class="o">;</span>
    <span class="nt">server_name</span> <span class="nt">159</span><span class="p">.</span><span class="nc">203</span><span class="p">.</span><span class="nc">186</span><span class="p">.</span><span class="nc">209</span><span class="o">;</span>

    <span class="nt">location</span> <span class="o">=</span> <span class="o">/</span><span class="nt">favicon</span><span class="p">.</span><span class="nc">ico</span> <span class="p">{</span> <span class="err">access_log</span> <span class="err">off</span><span class="p">;</span> <span class="err">log_not_found</span> <span class="err">off</span><span class="p">;</span> <span class="p">}</span>
    <span class="nt">location</span> <span class="o">/</span><span class="nt">static</span><span class="o">/</span> <span class="p">{</span>
        <span class="err">root</span> <span class="err">/home/bob/tips_api</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nt">location</span> <span class="o">/</span> <span class="p">{</span>
        <span class="err">include</span> <span class="err">proxy_params</span><span class="p">;</span>
        <span class="err">proxy_pass</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">unix</span><span class="o">:/</span><span class="n">run</span><span class="o">/</span><span class="n">gunicorn</span><span class="o">.</span><span class="n">sock</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nt">bob</span><span class="p">@</span><span class="k">ubuntu-s-1vcpu-1gb-nyc1-01</span><span class="o">:~/</span><span class="nt">tips_api</span><span class="o">$</span> <span class="nt">sudo</span> <span class="nt">ln</span> <span class="nt">-s</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">nginx</span><span class="o">/</span><span class="nt">sites-available</span><span class="o">/</span><span class="nt">tips_api</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">nginx</span><span class="o">/</span><span class="nt">sites-enabled</span>
<span class="nt">bob</span><span class="p">@</span><span class="k">ubuntu-s-1vcpu-1gb-nyc1-01</span><span class="o">:~/</span><span class="nt">tips_api</span><span class="o">$</span> <span class="nt">sudo</span> <span class="nt">nginx</span> <span class="nt">-t</span>
<span class="nt">nginx</span><span class="o">:</span> <span class="nt">the</span> <span class="nt">configuration</span> <span class="nt">file</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">nginx</span><span class="o">/</span><span class="nt">nginx</span><span class="p">.</span><span class="nc">conf</span> <span class="nt">syntax</span> <span class="nt">is</span> <span class="nt">ok</span>
<span class="nt">nginx</span><span class="o">:</span> <span class="nt">configuration</span> <span class="nt">file</span> <span class="o">/</span><span class="nt">etc</span><span class="o">/</span><span class="nt">nginx</span><span class="o">/</span><span class="nt">nginx</span><span class="p">.</span><span class="nc">conf</span> <span class="nt">test</span> <span class="nt">is</span> <span class="nt">successful</span>

<span class="nt">bob</span><span class="p">@</span><span class="k">ubuntu-s-1vcpu-1gb-nyc1-01</span><span class="o">:~/</span><span class="nt">tips_api</span><span class="o">$</span> <span class="nt">sudo</span> <span class="nt">systemctl</span> <span class="nt">restart</span> <span class="nt">nginx</span>
<span class="nt">bob</span><span class="p">@</span><span class="k">ubuntu-s-1vcpu-1gb-nyc1-01</span><span class="o">:~/</span><span class="nt">tips_api</span><span class="o">$</span> <span class="nt">sudo</span> <span class="nt">ufw</span> <span class="nt">delete</span> <span class="nt">allow</span> <span class="nt">8000</span>
<span class="nt">Rule</span> <span class="nt">deleted</span>
<span class="nt">Rule</span> <span class="nt">deleted</span> <span class="o">(</span><span class="nt">v6</span><span class="o">)</span>
<span class="nt">bob</span><span class="p">@</span><span class="k">ubuntu-s-1vcpu-1gb-nyc1-01</span><span class="o">:~/</span><span class="nt">tips_api</span><span class="o">$</span> <span class="nt">sudo</span> <span class="nt">ufw</span> <span class="nt">allow</span> <span class="s1">&#39;Nginx Full&#39;</span>
<span class="nt">Rule</span> <span class="nt">added</span>
<span class="nt">Rule</span> <span class="nt">added</span> <span class="o">(</span><span class="nt">v6</span><span class="o">)</span>
</pre></div>


<p>I ran into a weird error after this:</p>
<div class="highlight"><pre><span></span>Mar 04 10:06:18 ubuntu-s-1vcpu-1gb-nyc1-01 systemd[1]: nginx.service: Failed to parse PID from file /run/nginx.pid: Invalid argument
</pre></div>


<p>... which I could resolve using <a href="https://stackoverflow.com/a/42084804">this workaround</a>, but it was overshadowed by the Gunicorn ENV variable issue I described earlier, so not sure if this would have been a stopper.</p>
<p>And voilà: we have our PyBites API hosted on Digital Ocean!</p>
<p><img alt="API on Digital Ocean" src="https://pybit.es/images/django-rest-digital-ocean/remote-api-dev-server.png"></p>
<h2>Conclusion</h2>
<p>This was a fun exercise! We managed to turn PyBites Tips into its own service hosted in the cloud!</p>
<p>The only challenge was <code>gunicorn</code> not picking up environment variables from a file, but we got around that and it all works nicely now ...</p>
<p>Now go build your own API with the <a href="https://www.django-rest-framework.org/">Django REST Framework</a> and <a href="https://codechalleng.es/challenges/34/">PR us your code here</a>.</p>
<p>I will do a follow-up article on how to use the Slack API and its <a href="https://api.slack.com/slash-commands">Slash Commands</a> feature to <code>POST</code> tips to this API from our Slack. </p>
<p>By the way, PyBites Slack is a really cool place to hang out, you can join us <a href="https://join.slack.com/t/pybites/shared_invite/enQtNDAxODc0MjEyODM2LTNiZjljNTI2NGJiNWI0MTRkNjY4YzQ1ZWU4MmQzNWQyN2Q4ZTQzMTk0NzkyZTRmMThlNmQzYTk5Y2Y5ZDM4NDU">here</a>.</p>
<hr>
<p>Keep Calm and Code in Python!</p>
<p>-- Bob</p>
  </div>

  <hr>
  <p><strong>See an error in this post? Please submit a pull request <a href='https://github.com/pybites/pybites.github.io-src' target='_blank'>on Github.</a></strong></p>

  <div class="tag-cloud">
    <p>
      <a href="https://pybit.es/tag/django.html">Django</a>
      <a href="https://pybit.es/tag/apis.html">APIs</a>
      <a href="https://pybit.es/tag/django-rest-framework.html">Django REST Framework</a>
      <a href="https://pybit.es/tag/tips.html">tips</a>
      <a href="https://pybit.es/tag/digital-ocean.html">Digital Ocean</a>
      <a href="https://pybit.es/tag/django-commands.html">Django Commands</a>
      <a href="https://pybit.es/tag/postman.html">Postman</a>
      <a href="https://pybit.es/tag/nginx.html">Nginx</a>
      <a href="https://pybit.es/tag/postgres.html">postgres</a>
      <a href="https://pybit.es/tag/gunicorn.html">Gunicorn</a>
      <a href="https://pybit.es/tag/beautifulsoup.html">BeautifulSoup</a>
      <a href="https://pybit.es/tag/requests.html">requests</a>
      <a href="https://pybit.es/tag/curl.html">curl</a>
      <a href="https://pybit.es/tag/ssh.html">SSH</a>
      <a href="https://pybit.es/tag/linux.html">Linux</a>
      <a href="https://pybit.es/tag/deployment.html">deployment</a>
    </p>
  </div>

  <div class="center social-share">
    <p>    Like this article? Share it with your friends!
</p>
    <div class="addthis_native_toolbox"></div>
    <div class="addthis_sharing_toolbox"></div>
  </div>



<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'http-pybit-es';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
        Please enable JavaScript to view comments.

</noscript>
</article>

    <footer>
<p>&copy; pybites </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>

<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-89294245-1', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

	<script>window.twttr = (function(d, s, id) {
	var js, fjs = d.getElementsByTagName(s)[0],
		t = window.twttr || {};
	if (d.getElementById(id)) return t;
	js = d.createElement(s);
	js.id = id;
	js.src = "https://platform.twitter.com/widgets.js";
	fjs.parentNode.insertBefore(js, fjs);
	t._e = [];
	t.ready = function(f) {
		t._e.push(f);
	};
	return t;
	}(document, "script", "twitter-wjs"));</script>

  <script async defer src="https://buttons.github.io/buttons.js"></script>
	
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5859c6a67eb6254d" async="async"></script>


<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " PyBites ",
  "url" : "https://pybit.es",
  "image": "https://pybit.es/theme/img/profile.png",
  "description": "A Community that Masters Python through Code Challenges"
}
</script>
</body>
</html>